<?xml version="1.0" encoding="UTF-8" ?>
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
	xmlns:h="http://xmlns.jcp.org/jsf/html"
	xmlns:f="http://xmlns.jcp.org/jsf/core"
	xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
	xmlns:comp="http://xmlns.jcp.org/jsf/composite"
	xmlns:p="http://primefaces.org/ui" xmlns:o="http://omnifaces.org/ui"
	xmlns:pe="http://primefaces.org/ui/extensions"
	xmlns:fn="http://java.sun.com/jsp/jstl/functions"
	xmlns:df="http://lapsa.com/donkeyfaces"
	template="/WEB-INF/templates/clean.xhtml">
	<ui:define name="page-title">#{ui['name.site']}</ui:define>
	<ui:define name="page-content">

		<f:facet name="last">
			<df:outputStylesheet library="css" name="style.css"
				prodName="style.min.css" />
			<df:outputStylesheet library="font-awesome"
				name="font-awesome.min.css" />
		</f:facet>

		<h:form id="form">

			<ui:decorate
				template="/WEB-INF/templates/primefaces-growl.include.xhtml" />

			<f:metadata>
				<f:viewAction action="#{mainFacade.doInitialize}" />
			</f:metadata>

			<ui:include src="dialog.insurance-request.include.xhtml" />

			<h:panelGroup id="requestCloseDialog">
				<ui:include src="dialog.insurance-request-close.include.xhtml">
					<ui:param name="dialogWV" value="requestCloseDialogWV" />
					<ui:param name="ir" value="#{insuranceRequest.value}" />
					<ui:param name="update"
						value="@form:requestsTable @form:mainToolbarWrapper" />
				</ui:include>
			</h:panelGroup>

			<h:panelGroup id="progressCompleteDialog">
				<ui:include src="dialog.progress-complete.include.xhtml">
					<ui:param name="dialogWV" value="progressCompleteDialogWV" />
					<ui:param name="ir" value="#{insuranceRequest.value}" />
					<ui:param name="update"
						value="@form:requestsTable @form:mainToolbarWrapper" />
				</ui:include>
			</h:panelGroup>

			<p:remoteCommand name="refreshRequests"
				action="#{mainFacade.doRefresh}" process="@this" update="@form" />

			<ui:include src="filter.include.xhtml" />

			<h:panelGroup id="mainToolbarWrapper">
				<p:toolbar id="mainToolbar">
					<f:facet name="left">
						<p:commandButton value="Принять в обработку"
							icon="fa fa-play-circle"
							disabled="#{insuranceRequest.value.progressStatus ne 'NEW'}"
							action="#{mainFacade.doAcceptRequest}" process="@this"
							update="@this, requestsTable, mainToolbarWrapper" />

						<p:commandButton value="Приостановить" icon="fa fa-pause-circle"
							disabled="#{insuranceRequest.value.progressStatus ne 'ON_PROCESS'}"
							rendered="#{insuranceRequest.value.progressStatus ne 'ON_HOLD'}"
							action="#{mainFacade.doPauseRequest}" process="@this"
							update="@this, requestsTable, mainToolbarWrapper" />

						<p:commandButton value="Возобновить" icon="fa fa-play-circle"
							disabled="#{insuranceRequest.value.progressStatus ne 'ON_HOLD'}"
							rendered="#{insuranceRequest.value.progressStatus eq 'ON_HOLD'}"
							action="#{mainFacade.doResumeRequest}" process="@this"
							update="@this, requestsTable, mainToolbarWrapper" />

						<p:commandButton value="Завершено..." icon="fa fa-check-circle"
							disabled="#{insuranceRequest.value.progressStatus ne 'ON_PROCESS'}"
							process="@this" update="@this, progressCompleteDialog"
							oncomplete="PF('progressCompleteDialogWV').show(); return false;">
							<p:resetInput target="progressCompleteDialog" />
						</p:commandButton>

						<p:commandButton value="Закрыть заявку..."
							icon="fa fa-window-close"
							disabled="#{insuranceRequest.value.progressStatus ne 'FINISHED'}"
							process="@this" update="@this, requestCloseDialog"
							oncomplete="PF('requestCloseDialogWV').show(); return false;">
							<p:resetInput target="requestCloseDialog" />
						</p:commandButton>

					</f:facet>
				</p:toolbar>
				<p:sticky target="mainToolbarWrapper" />
			</h:panelGroup>

			<p:dataTable id="requestsTable" widgetVar="requestTable" var="req"
				value="#{insuranceRequests.requests}" selectionMode="single"
				selection="#{insuranceRequest.value}" rowKey="#{req.id}" rows="20"
				paginator="true" paginatorAlwaysVisible="false"
				paginatorTemplate="{CurrentPageReport} {FirstPageLink} {PreviousPageLink} {PageLinks} {NextPageLink} {LastPageLink} {RowsPerPageDropdown}"
				sortMode="multipe" sortOrder="DESCENDING" sortBy="#{req.created}"
				emptyMessage="Нет заявок удовлетворяющих критериям поиска"
				rowStyleClass="row-request-progress-#{req.progressStatus}">

				<p:ajax event="rowSelect" process="@this"
					update="@form:mainToolbarWrapper" />

				<!-- 				<p:ajax event="rowDblselect" process="@this" -->
				<!-- 					update="@form:viewInsuranceRequestDialogWrapper" -->
				<!-- 					oncomplete="PF('insuranceRequestDialogWV').show()" /> -->

				<p:column headerText="Продукт">
					<h:outputText
						value="#{insuranceProductTypeService.displayNameShort(req.productType)}" />
				</p:column>
				<p:column headerText="Тип" sortBy="#{req.type}"
					styleClass="#{not empty req.type ? ('col-request-' += req.type) : ''}">
					<h:outputText
						value="#{requestTypeService.displayNameShort(req.type)}" />
				</p:column>
				<p:column headerText="Номер" sortBy="#{req.id}">
					<h:outputText value="#{req.id}" />
				</p:column>
				<p:column headerText="Дата создания" sortBy="#{req.created}">
					<ui:decorate template="out-datetime.include.xhtml">
						<ui:param name="value" value="#{req.created}" />
					</ui:decorate>
				</p:column>
				<p:column headerText="Стадия">
					<h:outputText
						value="#{progressStatusService.displayNameShort(req.progressStatus)}" />
					<h:panelGroup styleClass="request-icon red-icon "
						rendered="#{req.transactionStatus eq 'NOT_COMPLETED'}">
						<i class="fa fa-ban " aria-hidden="true" />
					</h:panelGroup>
					<h:panelGroup styleClass="request-icon green-icon "
						rendered="#{req.transactionStatus eq 'COMPLETED'}">
						<i class="fa fa-check " aria-hidden="true" />
					</h:panelGroup>
				</p:column>
				<p:column headerText="Стоимость премии" style="text-align: right"
					sortBy="#{req.product.calculation.premiumCost}">
					<ui:decorate template="out-money.include.xhtml">
						<ui:param name="value"
							value="#{req.product.calculation.premiumCost}" />
					</ui:decorate>
				</p:column>
				<p:column headerText="Способ оплаты" sortBy="#{req.payment.method}">
					<h:outputText
						value="#{paymentMethodService.displayNameShort(req.payment.method)}" />
				</p:column>
				<p:column headerText="Статус оплаты" sortBy="#{req.payment.status}">
					<h:outputText
						value="#{paymentStatusService.displayNameShort(req.payment.status)}" />
				</p:column>
				<p:column headerText="Имя заявителя" sortBy="#{req.requester.name}">
					<h:outputText value="#{req.requester.name}" />
				</p:column>
				<p:column headerText="Email заявителя"
					sortBy="#{req.requester.email}">
					<h:outputText value="#{req.requester.email}" />
				</p:column>
				<p:column headerText="Телефон заявителя"
					sortBy="#{req.requester.phone}">
					<h:outputText value="#{req.requester.phone}" />
				</p:column>
				<p:column headerText="Дата закрытия" sortBy="#{req.closed}">
					<ui:decorate template="out-datetime.include.xhtml">
						<ui:param name="value" value="#{req.closed}" />
					</ui:decorate>
				</p:column>
			</p:dataTable>

		</h:form>

	</ui:define>
</ui:composition>
